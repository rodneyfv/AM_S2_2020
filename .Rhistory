while(sum(diff(R)<0)) R[which(diff(R)<0)+1] <- R[which(diff(R)<0)]
S <- df_N - C # Susceptible = population - confirmed
I <- C - D - R # Infectious = confirmed - deaths - recovered
deltaC <- diff(C) %>% set_names(df$date[-1])
deltaD <- diff(D) %>% set_names(df$date[-1])
deltaS <- diff(S) %>% set_names(df$date[-1])
#deltaNlogS <- -df_N*diff(log(S)) %>% set_names(df$date[-1])
deltaR <- diff(R) %>% set_names(df$date[-1])
deltaI <- diff(I) %>% set_names(df$date[-1])
# Removes last day, since it was already used to compute deltas t+1
C <- C[1:df_T] %>% set_names(df$date[1:df_T])
D <- D[1:df_T] %>% set_names(df$date[1:df_T])
S <- S[1:df_T] %>% set_names(df$date[1:df_T])
R <- R[1:df_T] %>% set_names(df$date[1:df_T])
I <- I[1:df_T] %>% set_names(df$date[1:df_T])
# kernel SIRD estimates
kern_sird <- run_SIRD(df = df, size_population = df_N, minimum_number_cases=50,
kc = 1, kd = 1, kr = 1, power_H = 0.4,
recovered_synthetic = TRUE, remove_last = 0)
wavetype = "d4"
J=5
# infection rate: raw estimates and wavelet estimates
beta_hat <- wave_sqrt_reg(-df_N*deltaS/(I*S),wavetype,J)
#beta_hat <- wave_sqrt_reg(deltaNlogS/I,wavetype,J)
plot(1:df_T,-df_N*deltaS/(I*S),type='l')
lines(1:df_T,beta_hat,type='l',col=2)
# recovery rate: raw estimates and wavelet estimates
nu_hat <- wave_sqrt_reg(deltaR/I,wavetype,J)
plot(1:df_T,deltaR/I,type='l')
lines(1:df_T,nu_hat,type='l',col=2)
# mortality rate: raw estimates and wavelet estimates
mu_hat <- wave_sqrt_reg(deltaD/I,wavetype,J)
plot(1:df_T,deltaD/I,type='l')
lines(1:df_T,mu_hat,type='l',col=2)
# residual analysis of beta_hat estimates
res_beta_hat <- beta_hat - (-df_N*deltaS/(I*S))
plot(res_beta_hat,beta_hat)
plot(res_beta_hat,-df_N*deltaS/(I*S))
plot(1:df_T,res_beta_hat,type='l')
beta_hat_local <- wave_sqrt_local_reg(-df_N*deltaS/(I*S),wavetype,J)
#beta_hat_local <- wave_sqrt_local_reg(deltaNlogS/I,wavetype,J)
plot(1:df_T,-df_N*deltaS/(I*S),type='l')
lines(1:df_T,beta_hat,type='l',col=2,lwd=2)
lines(1:df_T,beta_hat_local,type='l',col=3,lwd=2)
nu_hat_local <- wave_sqrt_local_reg(deltaR/I,wavetype,J)
plot(1:df_T,deltaR/I,type='l')
lines(1:df_T,nu_hat,type='l',col=2)
lines(1:df_T,nu_hat_local,type='l',col=3)
mu_hat_local <- wave_sqrt_local_reg(deltaD/I,wavetype,J)
plot(1:df_T,deltaD/I,type='l')
lines(1:df_T,mu_hat,type='l',col=2)
lines(1:df_T,mu_hat_local,type='l',col=3)
S_vol <- wave_sqrt_local_reg(deltaS^2,wavetype,J)
#S_vol <- wave_sqrt_local_reg((deltaNlogS)^2,wavetype,J)
#plot(1:(df_T-1),(deltaNlogS)^2,type='l')
plot(1:df_T,deltaS^2,type='l')
lines(1:df_T,S_vol,type='l',col=2,lwd=2)
I_vol <- wave_sqrt_local_reg(deltaI^2,wavetype,J)
plot(1:df_T,deltaI^2,type='l')
lines(1:df_T,I_vol,type='l',col=2)
R_vol <- wave_sqrt_local_reg(deltaR^2,wavetype,J)
plot(1:df_T,deltaR^2,type='l')
lines(1:df_T,R_vol,type='l',col=2)
D_vol <- wave_sqrt_local_reg(deltaD^2,wavetype,J)
plot(1:df_T,deltaD^2,type='l')
lines(1:df_T,D_vol,type='l',col=2)
Rt_hat <- (S/df_N) * beta_hat/(mu_hat + nu_hat)
Rt_hat_local <- (S/df_N) * beta_hat_local/(mu_hat_local + nu_hat_local)
plot(1:df_T,Rt_hat,type='l',col=2,lwd=2,ylim=c(0,10))
lines(1:df_T,Rt_hat_local,type='l',col=3,lwd=2)
lines(1:df_T,kern_sird$Rt,type='l',col=4,lwd=2)
munu_hat_local <- wave_local_reg(-(deltaS + deltaI)/I,wavetype,J)
Rt_hat_local2 <- (S/df_N) * beta_hat_local/munu_hat_local
plot(1:df_T,Rt_hat_local2,type='l',col=1,lwd=2,ylim=c(0,10))
lines(1:df_T,Rt_hat_local,type='l',col=3,lwd=2)
lines(1:df_T,kern_sird$Rt,type='l',col=4,lwd=2)
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
S[1]
S_b[1] <- S[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I[1]
I_b[1] <- I[1]
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
deltaS_b <- deltaS; deltaS_b[1] <- deltaS[1]
deltaI_b <- deltaI; deltaI_b[1] <- deltaI[1]
deltaR_b <- deltaR; deltaR_b[1] <- deltaR[1]
deltaD_b <- deltaD; deltaD_b[1] <- deltaD[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
i=2
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol)*eps_S[i-1], -.0001)
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
deltaS_b[i]
S_b[i] <- deltaS_b[i] + S_b[i-1]
S_b[i]
i
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
S_b[i] <- deltaS_b[i] + S_b[i-1]
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i])*eps_I[i]
I_b[i] <- deltaI_b[i] + I_b[i-1]
I_b[i]
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i])*eps_R[i], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i])*eps_D[i], .0001)
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
S_b[i] <- deltaS_b[i] + S_b[i-1]
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i])*eps_I[i]
I_b[i] <- deltaI_b[i] + I_b[i-1]
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i])*eps_R[i], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i])*eps_D[i], .0001)
}
plot(deltaS,type = 'l'); lines(deltaS_b,col=2)
plot(deltaR,type = 'l'); lines(deltaR_b,col=2)
plot(deltaD,type = 'l'); lines(deltaD_b,col=2)
plot(deltaI,type = 'l'); lines(deltaI_b,col=2)
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
deltaS_b <- deltaS; deltaS_b[1] <- deltaS[1]
deltaI_b <- deltaI; deltaI_b[1] <- deltaI[1]
deltaR_b <- deltaR; deltaR_b[1] <- deltaR[1]
deltaD_b <- deltaD; deltaD_b[1] <- deltaD[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
S_b[i] <- deltaS_b[i] + S_b[i-1]
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i])*eps_I[i]
I_b[i] <- deltaI_b[i] + I_b[i-1]
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i])*eps_R[i], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i])*eps_D[i], .0001)
}
plot(deltaS,type = 'l'); lines(deltaS_b,col=2)
plot(deltaR,type = 'l'); lines(deltaR_b,col=2)
plot(deltaD,type = 'l'); lines(deltaD_b,col=2)
plot(deltaI,type = 'l'); lines(deltaI_b,col=2)
beta_hat_local_b <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
plot(1:df_T,beta_hat_local_b,type='l')
lines(1:df_T,beta_hat_local,type='l',col=2,lwd=2)
nu_hat_local_b <- wave_sqrt_local_reg(deltaR_b/I_b,wavetype,J)
plot(1:df_T,nu_hat_local_b,type='l')
lines(1:df_T,nu_hat_local,type='l',col=3)
mu_hat_local_b <- wave_sqrt_local_reg(deltaD_b/I_b,wavetype,J)
plot(1:df_T,mu_hat_local_b,type='l')
lines(1:df_T,mu_hat_local,type='l',col=3)
Rt_hat_local_b <- (S_b/df_N) * beta_hat_local_b/(mu_hat_local_b + nu_hat_local_b)
plot(1:df_T,Rt_hat_local,type='l',col=2,lwd=2,ylim=c(0,10))
lines(1:df_T,Rt_hat_local_b,type='l',col=3,lwd=2)
mbeta_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mnu_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mmu_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mRt_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
for(b in 1:1000){
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
deltaS_b <- deltaS; deltaS_b[1] <- deltaS[1]
deltaI_b <- deltaI; deltaI_b[1] <- deltaI[1]
deltaR_b <- deltaR; deltaR_b[1] <- deltaR[1]
deltaD_b <- deltaD; deltaD_b[1] <- deltaD[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
S_b[i] <- deltaS_b[i] + S_b[i-1]
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i])*eps_I[i]
I_b[i] <- deltaI_b[i] + I_b[i-1]
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i])*eps_R[i], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i])*eps_D[i], .0001)
}
mbeta_hat_local_b[b,] <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
mnu_hat_local_b[b,] <- wave_sqrt_local_reg(deltaR_b/I_b,wavetype,J)
mmu_hat_local_b[b,] <- wave_sqrt_local_reg(deltaD_b/I_b,wavetype,J)
mRt_hat_local_b[b,] <- (S_b/df_N) * beta_hat_local_b/(mu_hat_local_b +
nu_hat_local_b)
}
b
mbeta_hat_local_b[b,] <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
summary(-df_N*deltaS_b/(I_b*S_b))
summary(S_b)
summary(I_b)
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
S_b[i] <- max(deltaS_b[i] + S_b[i-1], 1)
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i])*eps_I[i]
I_b[i] <- max(deltaI_b[i] + I_b[i-1], 1)
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i])*eps_R[i], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i])*eps_D[i], .0001)
}
mbeta_hat_local_b[b,] <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
mnu_hat_local_b[b,] <- wave_sqrt_local_reg(deltaR_b/I_b,wavetype,J)
mmu_hat_local_b[b,] <- wave_sqrt_local_reg(deltaD_b/I_b,wavetype,J)
mRt_hat_local_b[b,] <- (S_b/df_N) * beta_hat_local_b/(mu_hat_local_b +
nu_hat_local_b)
mbeta_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mnu_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mmu_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mRt_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
for(b in 1:1000){
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
deltaS_b <- deltaS; deltaS_b[1] <- deltaS[1]
deltaI_b <- deltaI; deltaI_b[1] <- deltaI[1]
deltaR_b <- deltaR; deltaR_b[1] <- deltaR[1]
deltaD_b <- deltaD; deltaD_b[1] <- deltaD[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
S_b[i] <- max(deltaS_b[i] + S_b[i-1], 1)
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i])*eps_I[i]
I_b[i] <- max(deltaI_b[i] + I_b[i-1], 1)
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i])*eps_R[i], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i])*eps_D[i], .0001)
}
mbeta_hat_local_b[b,] <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
mnu_hat_local_b[b,] <- wave_sqrt_local_reg(deltaR_b/I_b,wavetype,J)
mmu_hat_local_b[b,] <- wave_sqrt_local_reg(deltaD_b/I_b,wavetype,J)
mRt_hat_local_b[b,] <- (S_b/df_N) * beta_hat_local_b/(mu_hat_local_b +
nu_hat_local_b)
}
beta_upp <- apply(mbeta_hat_local_b, 2, function(x) quantile(x,.975))
beta_low <- apply(mbeta_hat_local_b, 2, function(x) quantile(x,.025))
plot(1:df_T,-df_N*deltaS/(I*S),type='l')
lines(1:df_T,beta_hat_local,type='l',col=2,lwd=2)
lines(1:df_T,beta_upp,type='l',col=3,lwd=2)
lines(1:df_T,beta_low,type='l',col=3,lwd=2)
summary(beta_upp)
mu_upp <- apply(mmu_hat_local_b, 2, function(x) quantile(x,.975))
mu_low <- apply(mmu_hat_local_b, 2, function(x) quantile(x,.025))
plot(1:df_T,deltaD/I,type='l')
lines(1:df_T,mu_hat_local,type='l',col=2,lwd=2)
lines(1:df_T,mu_upp,type='l',col=3,lwd=2)
lines(1:df_T,mu_low,type='l',col=3,lwd=2)
R0_upp <- apply(mRt_hat_local_b, 2, function(x) quantile(x,.975))
R0_low <- apply(mRt_hat_local_b, 2, function(x) quantile(x,.025))
plot(1:df_T,Rt_hat_local,type='l',col=2,lwd=2,ylim=c(0,10))
lines(1:df_T,R0_upp,type='l',col=3,lwd=2)
lines(1:df_T,R0_low,type='l',col=3,lwd=2)
summary(R0_low)
summary(R0_upp)
mRt_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
for(b in 1:1000){
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
deltaS_b <- deltaS; deltaS_b[1] <- deltaS[1]
deltaI_b <- deltaI; deltaI_b[1] <- deltaI[1]
deltaR_b <- deltaR; deltaR_b[1] <- deltaR[1]
deltaD_b <- deltaD; deltaD_b[1] <- deltaD[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
S_b[i] <- max(deltaS_b[i] + S_b[i-1], 1)
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i])*eps_I[i]
I_b[i] <- max(deltaI_b[i] + I_b[i-1], 1)
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i])*eps_R[i], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i])*eps_D[i], .0001)
}
mbeta_hat_local_b <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
munu_hat_local_b <- wave_sqrt_local_reg(-(deltaS_b + deltaI_b)/I_b,wavetype,J)
mRt_hat_local_b[b,] <- (S_b/df_N) * beta_hat_local_b/munu_hat_local_b
}
mRt_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
for(b in 1:1000){
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
deltaS_b <- deltaS; deltaS_b[1] <- deltaS[1]
deltaI_b <- deltaI; deltaI_b[1] <- deltaI[1]
deltaR_b <- deltaR; deltaR_b[1] <- deltaR[1]
deltaD_b <- deltaD; deltaD_b[1] <- deltaD[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i])*eps_S[i], -.0001)
S_b[i] <- max(deltaS_b[i] + S_b[i-1], 1)
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i])*eps_I[i]
deltaI_b[i] <- pmin(deltaI_b[i], -deltaS_b[i])
I_b[i] <- max(deltaI_b[i] + I_b[i-1], 1)
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i])*eps_R[i], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i])*eps_D[i], .0001)
}
mbeta_hat_local_b <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
munu_hat_local_b <- wave_sqrt_local_reg(-(deltaS_b + deltaI_b)/I_b,wavetype,J)
mRt_hat_local_b[b,] <- (S_b/df_N) * beta_hat_local_b/munu_hat_local_b
}
R0_upp <- apply(mRt_hat_local_b, 2, function(x) quantile(x,.975))
R0_low <- apply(mRt_hat_local_b, 2, function(x) quantile(x,.025))
plot(1:df_T,Rt_hat_local,type='l',col=2,lwd=2,ylim=c(0,10))
lines(1:df_T,R0_upp,type='l',col=3,lwd=2)
lines(1:df_T,R0_low,type='l',col=3,lwd=2)
plot(mbeta_hat_local_b, type='l')
plot(-df_N*deltaS_b/(I_b*S_b), type='l')
plot(-df_N*deltaS_b, type='l')
summary(-df_N*deltaS_b)
plot(-deltaS_b, type='l')
plot(-deltaS, type='l')
mRt_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
for(b in 1:1000){
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
deltaS_b <- deltaS; deltaS_b[1] <- deltaS[1]
deltaI_b <- deltaI; deltaI_b[1] <- deltaI[1]
deltaR_b <- deltaR; deltaR_b[1] <- deltaR[1]
deltaD_b <- deltaD; deltaD_b[1] <- deltaD[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i-1])*eps_S[i-1], -.0001)
S_b[i] <- max(deltaS_b[i] + S_b[i-1], 1)
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i-1])*eps_I[i-1]
deltaI_b[i] <- pmin(deltaI_b[i], -deltaS_b[i])
I_b[i] <- max(deltaI_b[i] + I_b[i-1], 1)
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i-1])*eps_R[i-1], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i-1])*eps_D[i-1], .0001)
}
mbeta_hat_local_b <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
munu_hat_local_b <- wave_sqrt_local_reg(-(deltaS_b + deltaI_b)/I_b,wavetype,J)
mRt_hat_local_b[b,] <- (S_b/df_N) * beta_hat_local_b/munu_hat_local_b
}
R0_upp <- apply(mRt_hat_local_b, 2, function(x) quantile(x,.975))
R0_low <- apply(mRt_hat_local_b, 2, function(x) quantile(x,.025))
plot(1:df_T,Rt_hat_local,type='l',col=2,lwd=2,ylim=c(0,10))
lines(1:df_T,R0_upp,type='l',col=3,lwd=2)
lines(1:df_T,R0_low,type='l',col=3,lwd=2)
plot(1:df_T,Rt_hat_local,type='l',col=2,lwd=2,ylim=c(0,2))
lines(1:df_T,R0_upp,type='l',col=3,lwd=2)
lines(1:df_T,R0_low,type='l',col=3,lwd=2)
mbeta_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mnu_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mmu_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
mRt_hat_local_b <- matrix(0,nrow=1000,ncol=df_T)
for(b in 1:1000){
eps_S <- rnorm(df_T)
eps_R <- rnorm(df_T)
eps_D <- rnorm(df_T)
eps_I <- rnorm(df_T)
deltaS_b <- deltaS; deltaS_b[1] <- deltaS[1]
deltaI_b <- deltaI; deltaI_b[1] <- deltaI[1]
deltaR_b <- deltaR; deltaR_b[1] <- deltaR[1]
deltaD_b <- deltaD; deltaD_b[1] <- deltaD[1]
S_b <- I_b <- rep(0,df_T)
S_b[1] <- S[1]
I_b[1] <- I[1]
for(i in 2:df_T){
deltaS_b[i] <- pmin(-beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N +
sqrt(S_vol[i-1])*eps_S[i-1], -.0001)
S_b[i] <- max(deltaS_b[i] + S_b[i-1], 1)
deltaI_b[i] <- beta_hat_local[i-1]*I_b[i-1]*S_b[i-1]/df_N -
(mu_hat_local[i-1] + nu_hat_local[i-1])*I_b[i-1] +
sqrt(I_vol[i-1])*eps_I[i-1]
I_b[i] <- max(deltaI_b[i] + I_b[i-1], 1)
deltaR_b[i] <- pmax(nu_hat_local[i-1]*I_b[i-1] +
sqrt(R_vol[i-1])*eps_R[i-1], .0001)
deltaD_b[i] <- pmax(mu_hat_local[i-1]*I_b[i-1] +
sqrt(D_vol[i-1])*eps_D[i-1], .0001)
}
mbeta_hat_local_b[b,] <- wave_sqrt_local_reg(-df_N*deltaS_b/(I_b*S_b),wavetype,J)
mnu_hat_local_b[b,] <- wave_sqrt_local_reg(deltaR_b/I_b,wavetype,J)
mmu_hat_local_b[b,] <- wave_sqrt_local_reg(deltaD_b/I_b,wavetype,J)
mRt_hat_local_b[b,] <- (S_b/df_N) * beta_hat_local_b/(mu_hat_local_b +
nu_hat_local_b)
}
beta_upp <- apply(mbeta_hat_local_b, 2, function(x) quantile(x,.975))
beta_low <- apply(mbeta_hat_local_b, 2, function(x) quantile(x,.025))
plot(1:df_T,-df_N*deltaS/(I*S),type='l')
lines(1:df_T,beta_hat_local,type='l',col=2,lwd=2)
lines(1:df_T,beta_upp,type='l',col=3,lwd=2)
lines(1:df_T,beta_low,type='l',col=3,lwd=2)
mu_upp <- apply(mmu_hat_local_b, 2, function(x) quantile(x,.975))
mu_low <- apply(mmu_hat_local_b, 2, function(x) quantile(x,.025))
plot(1:df_T,deltaD/I,type='l')
lines(1:df_T,mu_hat_local,type='l',col=2,lwd=2)
lines(1:df_T,mu_upp,type='l',col=3,lwd=2)
lines(1:df_T,mu_low,type='l',col=3,lwd=2)
plot(mu_upp,type='l')
setwd("/media/rodney/Arquivos/Doutorado/PED/PEDme731/AM_S2_2020/Programas/AM_S2_2020")
library(car)
library(xtable)
source("./Diag Multivariate Linear Models ME 731 2S 2020.R", encoding = "windows-1252")
#
dados<-read.table(file="./Dados/Amitripilina.txt", encoding = "windows-1252")
colnames(dados) <- c("Tot","Ami","Gen","Amt","Pr","Diap","Qrs")
dadosdf <- data.frame(dados)
#xtable(dados)
#
par(mfrow=c(1,1))
plot(dadosdf$Ami,dadosdf$Tot,pch=19,cex.axis=1.2,cex.lab=1.2,cex=1.2,xlab="Ami",ylab="Tot")
cor(dadosdf$Ami,dadosdf$Tot)
#
par(mfrow=c(1,2))
plot(dadosdf$Amt,dadosdf$Tot,pch=19,cex.axis=1.2,cex.lab=1.2,cex=1.2,xlab="Amt",ylab="Tot")
plot(dadosdf$Amt,dadosdf$Ami,pch=19,cex.axis=1.2,cex.lab=1.2,cex=1.2,xlab="Amt",ylab="Ami")
# A função lm, no caso multivariado, trabalha com o vec(B) e não com o Vec(B')
fit.model<-lm(cbind(dadosdf$Tot,dadosdf$Ami)~Amt,data=dadosdf)
summary(fit.model)
m.ajuste<-fit.manova<-manova(cbind(dadosdf$Tot,dadosdf$Ami)~Amt,data=dadosdf)
summary.manova(m.ajuste,test="Wilks")
summary.manova(m.ajuste,test="Pillai")
summary.manova(m.ajuste,test="Hotelling-Lawley")
summary.manova(m.ajuste,test="Roy")
aux<-summary.aov(m.ajuste)
#
# Estimando a matriz Sigma
mX <- as.matrix(model.matrix(fit.manova))
n<-nrow(mX)
eq<-ncol(mX)
mY <- cbind(dadosdf$Tot,dadosdf$Ami)
mB <- solve(t(mX)%*%mX)%*%t(mX)%*%mY
mSigma <- (t(mY-mX%*%mB)%*%(mY-mX%*%mB))/(n-eq)
mSigma
# Estimativa dos parâmetros
vbeta<- c(coef(m.ajuste))
mcovbeta <- vcov(m.ajuste)
mcovbeta
mcovbeta
mcovbeta <- vcov(m.ajuste)
epbeta <- as.vector(sqrt(diag(mcovbeta)))
#
quantt <- qt(0.975,df=17-2)
mresult <- cbind(vbeta,epbeta,vbeta-quantt*epbeta,vbeta+quantt*epbeta,vbeta/epbeta,2*(1-pt(vbeta/epbeta,df=17-2)))
xtable(mresult)
# Valores preditos (usando a aproximação pela normal)
# Variável Tot
par(mfrow=c(1,2))
m.fitted <- fitted(fit.model)
plot(dadosdf$Amt,dadosdf$Tot,pch=19,cex.axis=1.2,cex.lab=1.2,cex=1.2,xlab="amt",ylab="Tot",ylim=c(000,4000))
lines(dadosdf$Amt,m.fitted[,1],col=1,type="l",lwd=2,pch=19,cex.axis=1.2)
# média
epmupred <- sqrt(mcovbeta[1,1] + mcovbeta[2,2]*(sort(dadosdf$Amt^2)) + mcovbeta[1,2])
liicmupred <- sort(m.fitted[,1]) - 1.96*epmupred
liscmupred <- sort(m.fitted[,1]) + 1.96*epmupred
lines(sort(dadosdf$Amt),liicmupred,col=2,type="l",lwd=2,lty=2,pch=19,cex.axis=1.2)
lines(sort(dadosdf$Amt),liscmupred,col=2,type="l",lwd=2,lty=2,pch=19,cex.axis=1.2)
# uma única observação
epY <- sqrt(mcovbeta[1,1] + mcovbeta[2,2]*(sort(dadosdf$Amt^2)) + mcovbeta[1,2]+diag(mSigma)[1])
liicY <- sort(m.fitted[,1]) - 1.96*epY
liscY <- sort(m.fitted[,1]) + 1.96*epY
